<script src="../js/jquery.tmpl.min.js" type="text/javascript">
</script>
<script type="text/x-jquery-tmpl" id="relayJump">
  <div class="resDialog">
  <div class="reshen">
  请重新连接路由器
  </div>
    <div class="reshen2">
  (是否跳转至路由器新管理地址？)
  </div>
   <div class="reshen3 pt50">
   <div class="wifibut">
	<div class="inxiaobut left w150 ml20"><a class="xiaobtn" id="Jumpque">确定</a></div>
	<div class="inxiaobut left w150 ml10" id="Jumpqu"><a class="xiaobtn">取消</a></div>
	<div class="clear"></div>
   </div>						
   </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="Relay">
  	<div class="relayDialogTable">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td>
			<div>
			<div class="wuxian">
			<span>无线中继模式（扩展现有无线网络）</span>
			<a id="wuxianW" class="wuxianW" href="javascript:;"></a>
			</div>
			<div class="youxian">
			<span>有线中继模式（扩展现有网络）</span>
			<a id="youxianY" class="youxianY" href="javascript:;"></a>
			</div>
			<div class="clear"></div>
			</div>
			</td>
		</tr>
		<tr>
			<td>
				<div class="relayDialogbut">
					<a id="relaylast" class="xiaobtn">
						下一步
						</a>
				</div>
			</td>
		</tr>
	</table>
	</div>
	<input type="hidden" id="patterntype" value="" />
</script>

<script type="text/x-jquery-tmpl" id="pattern">
  	<div class="patternDialogTable">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td>
			<div class="patterndiv">
			1. 开始中继前请确保将小橙路由器的WAN口与主路由器的LAN口
通过网线相连。<br/>
2. 中继后小橙路由部分功能将被屏蔽，可以通过主路由器进行网络
管理。
			</div>
			<hr class="hr2" size="1" />
			</td>
		</tr>
		<tr>
			<td>
				<div class="relayDialogbut">
					<a id="fixedbtn" class="xiaobtn">
						开始有线中继
						</a>
				</div>
			</td>
		</tr>
	</table>
	</div>
</script>
<script type="text/x-jquery-tmpl" id="wireless">
<div class="wirelessDialogTable">
<div class="wirelesstab">用于被放大的无线网络</div>
<div>
<form id="WirelessRelayForm" method="post" action="">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="20%">
				<span>
					网络名称:
				</span>
			</td>
			<td width="60%">
			   <div id="auto">
				<select id="sel_x" name="sel_x">
				    <option value="0">请选择</option>
				</select>
			   </div>
			   <div id="manual">
				<input id="interName" name="interName" class="{checkinterName:true,maxlength:32} textinput5" type="text" />
				<div class="Prompt3"></div>
			   </div>
			</td>
			<td width="20%" align="left">
			<a id="Settings" class="biaoqianwifi" href="#">手动输入</a>
			<a id="relayresult" class="biaoqianwifi" href="javascript:;">刷新</a>
			</td>
		</tr>
		<tr id="encryptiontr">
			<td>
				<span>
					加密方式:
				</span>
			</td>
			<td>
				<select id="sel_h" name="sel_h">
				    <option value="mixed-psk">混合加密（WPA/WPA2）</option>
					<option value="psk2">强加密（WPA2）</option>
                    <option value="none">无加密</option>
				</select>
			</td>
			<td>
			</td>
		</tr>
		<tr id="pwdtr">
			<td>
				<span>
					密码:
				</span>
			</td>
			<td>
				<input id="interPwd" name="interPwd" class="{checkinterPwd:true,checkbewtoonwifipwd:true,checkChinesewifipwd:true} textinput5" type="password" />
				<div class="Prompt3"></div>
			</td>
			<td>
			</td>
		</tr>
		<tr>
			<td colspan="3" valign="middle">
			<div class="chequan">
			    <input type="checkbox" checked="checked" id="checkwifi" />
				<div class="chewifi">中继后的WiFi使用相同的名称和密码</div>
			</div>
			</td>
		</tr>
		<tr id="wifipwdtr">
			<td colspan="3" valign="middle">
			<div class="wirelesstabs">中继后的WiFi名称和密码</div>
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="20%">
				<span>
					WiFi名称:
				</span>
			</td>
			<td width="60%">
				<input id="WIFIName" name="WIFIName" class="{checkWIFIName:true,maxlength:32} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
			<td width="20%">
			</td>
		</tr>
		<tr>
			<td>
				<span>
					加密方式:
				</span>
			</td>
			<td>
				<select id="sel_d" name="sel_d">
				    <option value="mixed-psk">混合加密（WPA/WPA2）</option>
					<option value="psk2">强加密（WPA2）</option>
                    <option value="none">无加密</option>
				</select>
			</td>
			<td>
			</td>
		</tr>
		<tr id="pwdtr2">
			<td>
				<span>
					密码:
				</span>
			</td>
			<td>
				<input id="WIFIPwd" name="WIFIPwd" class="{checkWIFIPwd:true,checkbewtoonwifipwd:true,checkChinesewifipwd:true} textinput5" type="password" />
				<div class="Prompt3"></div>
			</td>
			<td>
			</td>
		</tr>
		</table>
			
			</td>
		</tr>
		<tr>
			<td colspan="3">
				<div class="zishiyDialogbut">
					<button type="submit" id="Repeaterbtn" class="xiaobtn">
						开始无线中继模式
						</button>
				</div>
			</td>
		</tr>
	</table>
	</div>
	</div>
	</form>
</script>

<script type="text/x-jquery-tmpl" id="retry">
  <div class="resDialog">
	<div class="reshen">
		检测路由器没有插入网线
	</div>
	<div class="reshen2">
		请检查网线是否连接正常后再试
	</div>
	<div class="reshen3 pt50 pb30">
		<div class="wifibut">
			<div class="inxiaobut left w150 ml20">
				<a class="xiaobtn" id="TryAgainbtn">
					再试一次
				</a>
			</div>
			<div class="inxiaobut left w150 ml10" id="rescolose">
				<a id="closeBtn" class="xiaobtn">
					取消
				</a>
			</div>
			<div class="clear">
			</div>
		</div>
	</div>
</div>
</script>

<script type="text/x-jquery-tmpl" id="Resloading">
  <div class="resDialog">
	<img src="../image/loading.gif" width="99" height="99" class="resloading2"
	/>
	<div class="reshen4">
		正在尝试中继路由器,请不要关闭浏览器
	</div>
	<div class="reshen8">
		中继过程中，无线客户端可能漫游到其他热点，请重新连接
	</div>
</div>
</script>
<script type="text/x-jquery-tmpl" id="backupsuress">
 <div class="resDialog">
	<div class="reshen7">
		恭喜，小橙路由器一键中继设置成功！
	</div>
	<div class="reshen10">
		无线网络名称：
	</div>
	<div class="reshen9">
	<label style="color:#ffa37d;font-size:16px;" id="wifissid"></label>
	</div>
	<div class="reshen10">
		登陆路由器地址为：
	</div>
	<div class="reshen9">
	<label style="color:#ffa37d;font-size:16px;" id="wifiIp"></label>
	</div>
	<div class="reshen10">
		或域名地址：
	</div>
	<div class="reshen9">
	<label style="color:#ffa37d;font-size:16px;">i.chengwifi.com</label></div>
	<div class="clear"></div>
	<div class="zishiyDialogbut">
		<a id="quedingbtn" class="xiaobtn">
			确定
		</a>
	</div>
</div>
</script>

<script type="text/x-jquery-tmpl" id="errormsgDIV">
 <div class="resDialog">
	<div class="reshen7">
		中继失败
	</div>
	<div class="reshen2">
		<label id="errormsg"></label>
	</div>
	<div class="zishiyDialogbut">
		<a id="errorbtn" class="xiaobtn">
			确定
		</a>
	</div>
</div>
</script>
<script type="text/x-jquery-tmpl" id="backupsuresslen">
<div class="resDialog">
	<div class="reshen7">
		恭喜，小橙路由器一键中继设置成功！
	</div>
	<div class="reshen10">
		登陆路由器地址为：
	</div>
	<div class="reshen9">
	<label style="color:#ffa37d;font-size:16px;" id="wifiIplen"></label>
	</div>
	<div class="reshen10">
		或域名地址：
	</div>
	<div class="reshen9">
	<label style="color:#ffa37d;font-size:16px;">i.chengwifi.com</label></div>
	<div class="clear"></div>
	<div class="zishiyDialogbut">
		<a id="quedingbtnlen" class="xiaobtn">
			确定
		</a>
	</div>
</div>
</script>
<script src="../js/jquery.selectlist-wifi.js">
</script>
<script src="../js/jquery.selectlist.js">
</script>
<script type="text/javascript">
    var index;
$('#Relaydialogtable').html($("#Relay").html());
$('#schemadialogtable').html($("#wireless").html());
$("#RelayBtn").click(function() {
	index = layer.open({
		type: 1,
		title: '模式切换',
		area: ['500px', 'auto'],
		shadeClose: false,
		content: $('#Relaydialogtable')
	});
})

$("#relaylast").click(function() {
	var type = $("#patterntype").val();
	if (type != '') {
		layer.close(index);
		if (type == '1') {
			index = layer.open({
				type: 1,
				title: '无线中继模式',
				area: ['500px', 'auto'],
				shadeClose: false,
				content: $('#schemadialogtable')
			});
		} else if (type == '2') {
			index = layer.open({
				type: 1,
				title: '有线中继模式',
				area: ['500px', 'auto'],
				shadeClose: false,
				content: $('#pattern').html()
			});

			$("#fixedbtn").click(function() {
				layer.close(index);
				detectwanLran();
			})
		}
	}

	$('#layui-layer' + index).height('auto');
	$('.layui-layer-content').height('auto');
})

$("#wuxianW").click(function() {
	$("#wuxianW").attr("class", "wuxiancrru");
	$("#youxianY").attr("class", "youxianY");
	$("#patterntype").val('1');
});

$("#youxianY").click(function() {
	$("#youxianY").attr("class", "youxiancrru");
	$("#wuxianW").attr("class", "wuxianW");
	$("#patterntype").val('2');
});

function Getselectwifilist(){
$('#sel_x').selectwifilist({
	zIndex: 10,
	width: 259,
	height: 39,
	borderRadius: 5,
	onChange: function() {
		var value = $("input[name='encryption']").val();
		if (value == 'none') {
			$("#pwdtr").hide();
		} else {
			$("#pwdtr").show();
		}
		$('#layui-layer' + index).height('auto');
$('.layui-layer-content').height('auto');
	}
});

}

$('#sel_h').selectlist({
	zIndex: 10,
	width: 259,
	height: 39,
	borderRadius: 5,
	onChange: function() {
		var value = $("input[name='sel_h']").val();
		if (value == 'none') {
			$("#pwdtr").hide();
		} else {
			$("#pwdtr").show();
		}
	}
});

$('#sel_d').selectlist({
	zIndex: 10,
	width: 259,
	height: 39,
	borderRadius: 5,
	onChange: function() {
		var value = $("input[name='sel_d']").val();
		if (value == 'none') {
			$("#pwdtr2").hide();
		} else {
			$("#pwdtr2").show();
		}
		$('#layui-layer' + index).height('auto');
        $('.layui-layer-content').height('auto');
	}
});

$("#checkwifi").bind("click",
function(e) {
	var theEvent = window.event || e;
	var theObj = theEvent.target || theEvent.srcElement;
	var selectedvalue = $(this).is(':checked');
	if (!selectedvalue) {
		Getrelay();
		$("#wifipwdtr").stop().slideDown(0);
	} else {
		$("#wifipwdtr").stop().slideUp(0);
	}
});

$(function() {
	$('#wifipwdtr').hide();
	$("#auto").show();
	$("#manual").hide();
	$("#encryptiontr").hide();
	$("#pwdtr").hide();
	$("#Settings").click(function() {
		if ($("#Settings").text() == "手动输入") {
			$("#Settings").text("自动搜索");
			$("#auto").hide();
			$("#manual").show();
			$("#encryptiontr").show();
            $('#relayresult').hide();
			var value = $("input[name='sel_h']").val();
			if (value == 'none') {
				$("#pwdtr").hide();
			} else {
				$("#pwdtr").show();
			}
		} else {
			$("#Settings").text("手动输入");
			$("#auto").show();
			$("#manual").hide();
			$("#encryptiontr").hide();
			$('#relayresult').show();
			var value = $("input[name='encryption']").val();
			if (value == 'none') {
				$("#pwdtr").hide();
			} else {
				$("#pwdtr").show();
			}
		}
	});
});

$('#relayresult').click(function(){
GetWifiList();
});


function detectwanLran()
{
index = layer.load(0, {shade: [0.5,'#252525']});
$.ajax({
	type: "get",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/detect_wan_type",
	dataType: "json",             
	success: function(result) {
	   if(result.code=='0') 
	   {
		   layer.close(index);
		   if(result.wanType==99)
		   {
			   index = layer.open({
					type: 1,
					title: '有线中继模式',
					area: ['500px', 'auto'],
					shadeClose: false,
					content: $('#retry').html()
				});   
			   
			   $("#TryAgainbtn").click(function() {
					layer.close(index);
					detectwanLran();
				})

				$("#closeBtn").click(function() {
					layer.close(index);
				})
		    }else{
				setlanrepeater();
			}
	   }
	   else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	 }});
}

function setlanrepeater()
{
		 index = layer.open({
					type: 1,
					title: '操作提示',
					area: ['500px', 'auto'],
					shadeClose: false,
					closeBtn: 0,
					content: $('#Resloading').html()
				});
		  $.ajax({
	type: "post",
	url: 'http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/set_lan_repeater',
	data: {},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
			wifiip=result.ip;
			layer.close(index);
			
					index = layer.open({
						type: 1,
						title: '操作提示',
						area: ['499px', '330px'],
						shadeClose: false,
						closeBtn: 0,
						content: $('#backupsuresslen').html()
					})
					$('#wifiIplen').html(wifiip);

					$("#quedingbtnlen").click(function() {
						layer.close(index);
						index=layer.open({
			                  type: 1,
			                  title: '操作提示',
		                   	  area: ['460px', '262px'],
			                  shadeClose: false,
			                  content: $('#relayJump').html()
		                });
						
					$("#Jumpqu").click(function() {
						layer.close(index);
					});
					$("#Jumpque").click(function() {
						location.href = 'http://'+wifiip;
					});
					})
		}else
		{
		layer.close(index);
		index = layer.open({
						type: 1,
						title: '操作提示',
						area: ['460px', '300px'],
						shadeClose: false,
						closeBtn: 0,
						content: $('#errormsgDIV').html()
					})
					$('#errormsg').html('错误码:'+result.code+"/错误信息："+result.errmsg);
                   
					$("#errorbtn").click(function() {
						layer.close(index);
					})
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}});
}

function GetWifiList(){
		$('#sel_x').empty();
		data="";
		$('#sel_x').html('<div style="padding-top:10px;padding-left:10px;">正在搜索无线网络</div>');
        $.ajax({
            url: 'http://192.168.0.196/cgi-bin/luci/cheng/networkmanager/get_wifi_scan_result?index=1',
            type: 'GET',
            dataType: 'json',
            success: function(res){
                if( res.code == 0 ){
                    if( res.list.length > 0 ){
                        var fragment = document.createDocumentFragment();
                        var list = res.list;
                        var select = $('#sel_x');

                        $(list).each(function(index, item){
                            var option = $('<option />');
                            option.attr('data-ssid',item.ssid);
                            option.text(item.ssid);
                            option.attr('data-channel', item.channel);
                            option.attr('data-enctype', item.enctype);
                            option.attr('data-encryption', item.encryption);
							
							if(data==""){encryption=item.encryption;data+=item.encryption;if (item.encryption == 'none') {$("#pwdtr").hide();} else {$("#pwdtr").show();}}else{data+=","+item.encryption}
                            if( item.encryption == 'none' ){
                                if( item.signalPercent > 75 ){
                                    option.addClass( 'no-encryption-4' );
                                }else if( item.signalPercent > 50 && item.signalPercent <= 75 ){
                                    option.addClass( 'no-encryption-3' );
                                }else if( item.signalPercent > 25 && item.signalPercent <= 50 ){
                                    option.addClass( 'no-encryption-2' );
                                }else if( item.signalPercent <= 25 ){
                                    option.addClass( 'no-encryption-1' );
                                }
                            }else{
                                if( item.signalPercent > 75 ){
                                    option.addClass( 'is-encryption-4' );
                                }else if( item.signalPercent > 50 && item.signalPercent <= 75 ){
                                    option.addClass( 'is-encryption-3' );
                                }else if( item.signalPercent > 25 && item.signalPercent <= 50 ){
                                    option.addClass( 'is-encryption-2' );
                                }else if( item.signalPercent <= 25 ){
                                    option.addClass( 'is-encryption-1' );
                                }
                            }
                            fragment.appendChild(option[0]);
                        });
                        select.empty();
                        select[0].appendChild(fragment);
						Getselectwifilist();
                    }else{
						layer.alert('未能扫描到Wi-Fi');
                    }
                }
            }
        });
    };
	
	
	
	function Getrelay(){
$.getJSON("http://192.168.0.196/cgi-bin/luci/cheng/networkmanager/get_wifi_setting",{index:1},function(result)
	{
		if(result.code=='0'){
			$("#WIFIName").val(result.wifiinfo.ssid);
			$("#sel_d").find("[data-value='"+result.wifiinfo.encryption+"']").click();
			$("#WIFIPwd").val(result.wifiinfo.password);
		}else
	    {
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	});
}
</script>