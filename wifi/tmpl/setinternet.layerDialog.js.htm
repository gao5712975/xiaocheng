<script src="js/jquery.tmpl.min.js" type="text/javascript">
</script>

<script type="text/x-jquery-tmpl" id="SetInternet">
	<div class="AddTableDiaLog">
	<form id="EquipmentForm" method="post" action="">
	<input type="hidden" id="hiddenipname" />
	<table id="dynamicTable" width="100%" border="0" cellspacing="0" cellpadding="0">
		<thead>
			<tr>
				<td align="center" width="20%">设备名称</td>
				<td align="center" width="35%">IP地址</td>
				<td align="center" width="35%">MAC地址</td>
				<td align="center" width="10%">操作</td>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<div class="inertonebtn2">
	<a id="btn_addtr">再加一项</a>
	</div>
	<div class="bangding2">
	<button type="submit" class="xiaobtn">确定绑定</button>
	</div>
	</form>
	</div>
</script>
<script type="text/x-jquery-tmpl" id="pppoeType">
<form id="ppponeTypeForm" method="post" action="">
					<table width="100%" border="0" cellpadding="0" cellspacing="0">
				　		<tr>
							<td width="20%">
								<span>
									上网帐号:
								</span>
							</td>
							<td width="80%" align="left">
								<input id="internetName" name="internetName" class="{required:true,messages:{required:'请输入上网帐号'},maxlength:127,checkspecial:true,checkChinese:true} textinput5"
								maxlength="25" type="text"  />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									上网密码:　
								</span>
							</td>
							<td align="left">
								<input id="internetpwd" name="internetpwd" class="{required:true,messages:{required:'请输入上网密码'},maxlength:127,checkspecial:true,checkChinese:true} textinput12"
								type="password" />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									最大传输单元（MTU）:
								</span>
							</td>
							<td align="left">
								<input id="transmissionUnit" name="transmissionUnit" class="{checkmtu:true} textinput5" value="1480" type="text" placeholder="默认值：1480"/>
							</td>
						</tr>
						<tr>
							<td>
								<span>
									高级选项：
								</span>
							</td>
							<td align="left" style="height:10px">
								<input type="checkbox" id="functions" name="functions" />
								<label for="functions">
								</label>
							</td>
						</tr>
						<tr id="waiinternet">
							<td colspan="2">
								<div class="setwifibiaodan">
									<table width="100%" border="0" cellpadding="0" cellspacing="0">
									    <tr>
							<td>
								<span>
									服务名称:
								</span>
							</td>
							<td align="left">
								<input id="serverName" name="serverName" class="{maxlength:127,checkspecial:true,checkChinese:true} textinput5"
								type="text" />
							</td>
						</tr>
						
										<tr>
											<td width="20%">
												<span>
													首选DNS:
												</span>
											</td>
											<td width="80%">
												<input id="masterServer" name="masterServer" class="{checkbdns:true} textinput5" type="text" />
											</td>
										</tr>
										<tr>
											<td>
												<span>
													备选DNS:
												</span>
											</td>
											<td>
												<input id="journeyServer" name="journeyServer" class="{checkbdns:true} textinput5" type="text" />
											</td>
										</tr>
									</table>
								</div>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<div class="wifibut2">
									<div class="inxiaobut">
										<button type="submit" id="ppponebtn" class="xiaobtn">
											应用
										</button>
									</div>
									<div class="inxiaobut">
										<a class="xiaobtn" onclick="refresh()" href="javascript:;">
											取消
										</a>
									</div>
									<div class="clear">
									</div>
								</div>
							</td>
						</tr>
					</table>
                    </form>
</script>
<script type="text/x-jquery-tmpl" id="dhcpType">
<form id="dhcpTypeForm" method="post" action="">
<table width="100%" border="0" cellpadding="0" cellspacing="0">
	<tr>
		<td width="20%">
			<span>
				高级选项：
			</span>
		</td>
		<td width="80%" align="left" style="height:10px">
			<input type="checkbox" id="deployDNS" name="deployDNS" />
			<label for="deployDNS">
			</label>
		</td>
	</tr>
	<tr id="deployDNSDiv">
		<td colspan="2">
			<div class="setwifibiaodan">
				<table width="100%" border="0" cellpadding="0" cellspacing="0">
					<tr>
						<td width="20%">
							<span>
								首选DNS:
							</span>
						</td>
						<td width="80%">
							<input id="masterDNSServer" name="masterDNSServer" class="{checkbdns:true} textinput5" type="text" />
						</td>
					</tr>
					<tr>
						<td>
							<span>
								备选DNS:
							</span>
						</td>
						<td>
							<input id="journeyDNSServer" name="journeyDNSServer" class="{checkbdns:true} textinput5" type="text" />
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
	<tr>
		<td colspan="2">
			<div class="wifibut2">
				<div class="inxiaobut">
					<button type="submit" class="xiaobtn">
						应用
					</button>
				</div>
				<div class="inxiaobut">
					<a class="xiaobtn" onclick="refresh()" href="javascript:;">
						取消
					</a>
				</div>
				<div class="clear">
				</div>
			</div>
		</td>
	</tr>
</form>
</script>
</script>
<script type="text/x-jquery-tmpl" id="staticType">
<form id="staticTypeForm" method="post" action="">
<table width="100%" border="0" cellpadding="0" cellspacing="0">
						<tr>
							<td width="20%">
								<span>
									IP地址：
								</span>
							</td>
							<td width="80%" align="left" style="height:10px">
								<input id="ipAddress" name="ipAddress" class="{required:true,messages:{required:'请输入IP地址'},checkip:true} textinput5" type="text" />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									子网掩码：
								</span>
							</td>
							<td align="left" style="height:10px">
								<input id="subnetMask" name="subnetMask" class="{required:true,messages:{required:'请输入子网掩码'},checkmask:true} textinput5" type="text" />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									默认网关：
								</span>
							</td>
							<td align="left" style="height:10px">
								<input id="gateway" name="gateway" class="{required:true,messages:{required:'请输入默认网关'},checkgateway:true} textinput5" type="text" />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									首选DNS：
								</span>
							</td>
							<td align="left" style="height:10px">
								<input id="masterstaticServer" name="masterstaticServer" class="{required:true,messages:{required:'请输入首选DNS'},checkdns:true} textinput5" type="text" />
							</td>
						</tr>
						<tr>
							<td>
								<span>
									备选DNS：
								</span>
							</td>
							<td align="left" style="height:10px">
								<input id="journeystaticServer" name="journeystaticServer" class="{checkbdns:true} textinput5" type="text" />
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<div class="wifibut2">
									<div class="inxiaobut">
										<button type="submit" class="xiaobtn">
											应用
										</button>
									</div>
									<div class="inxiaobut">
										<a class="xiaobtn" onclick="refresh()" href="javascript:;">
											取消
										</a>
									</div>
									<div class="clear">
									</div>
								</div>
							</td>
						</tr>
					</table>
					</form>
</script>



<script type="text/x-jquery-tmpl" id="res">
  <div class="resDialog">
  <div class="reshen">
  确定要重启路由器吗？
  </div>
    <div class="reshen2">
  (该操作将暂时断开与路由器的连接)
  </div>
   <div class="reshen3 pt50">
   <div class="wifibut">
								<div class="inxiaobut left w150 ml20">
									<a class="xiaobtn" id="resque">
										确定
									</a>
								</div>
								<div class="inxiaobut left w150 ml10" id="rescolose">
									<a class="xiaobtn">
										取消
									</a>
								</div>
								<div class="clear">
								</div>
							</div>
   </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="Resloading">
  <div class="resDialog">
  <img src="../image/loading.gif" width="99" height="99" class="resloading" />
  <div class="reshen4">
  路由器正在重启，请勿断电
  </div>
    <div class="reshen2">
  还需60s
  </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="Ressuress">
  <div class="resDialog">
   <img src="../image/suerss.png" width="99" height="99" class="resloading" />
  <div class="reshen4">
  路由器重启成功！
  </div>
  </div>
</script>

<script type="text/x-jquery-tmpl" id="dhcpList">
<div class="blackbai">
			<div class="blackbaititle">已绑定列表</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
			<tr>
			<td>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="blacktr">
			<tr>
			<td width="25%">设备名</td>
			<td width="25%">IP地址</td>
			<td width="25%">MAC地址</td>
			<td width="25%">操作</td>
			</tr>
			</table>
			<td>
			</tr>
			<tr>
			<td>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="baixian">
			{{each(i,device2) list}}
			<tr>
			<td width="25%">${device2.name}</td>
			<td width="25%">${device2.ip}</td>
			<td width="25%">${device2.mac}</td>
			<td width="25%"><a class="xbtn" onclick="jiechuclick('${device2.mac}')" href="javascript:;">解除绑定</a></td>
			</tr>
			{{/each}}
			</table>
			</td>
			</tr>
			</table>
			</div>
            
            
			<div class="blackbai">
			<div class="blackbaititle">在线设备列表</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
			<tr>
			<td>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="blacktr">
			<tr>
			<td width="25%">设备名</td>
			<td width="25%">IP地址</td>
			<td width="25%">MAC地址</td>
			<td width="25%">操作</td>
			</tr>
			</table>
			<td>
			</tr>
			<tr>
			<td>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="baixian">
			{{each(i,device) devicelist}}
			<tr>
			<td width="25%">${device.name}</td>
			<td width="25%">${device.ip}</td>
			<td width="25%">${device.mac}</td>
			{{if device.tag=='0'}}
			<td width="25%"><a class="xbtn" onclick="Defriendclick('${device.ip}','${device.mac}','${device.name}')" href="javascript:;">绑定</a></td>
			{{else}}
			<td width="25%"><a class="xbtnhui" onclick="javascript:;" href="javascript:;">绑定</a></td>
			{{/if}}	
			</tr>
			{{/each}}
			</table>
			</td>
			</tr>
			</table>
			</div>
</script>



<script type="text/javascript">
    var index;
    $('#SetInternetdialogtable').html($("#SetInternet").html());
	$('#Resdialogtable').html($("#res").html());
	$("#InertBtn").click(function() {
		index=layer.open({
			type: 1,
			fix:false,
			title: '添加绑定设备',
			area: ['640px', 'auto'],
			shadeClose: false,
			content: $('#SetInternetdialogtable')
		});
		$('.labipname').html(startIP);
		$('#hiddenipname').val(startIP);
		$('#layui-layer'+index).height('auto');
		$('.layui-layer-content').height('auto');
	})

$(function () {
	var show_count = 32;   //要显示的条数
	var count = 1;    //递增的开始值，这里是你的ID
	$("#btn_addtr").click(function () {
		var length = $("#dynamicTable tbody tr").length;
		if (length < show_count)    //点击时候，如果当前的数字小于递增结束的条件
		{
			$("#tabs"+(length+1)+" tbody tr").clone().appendTo("#dynamicTable tbody");   //在表格后面添加一行
		}else
		{
			layer.msg('一次只能添加32个');
		}
	});
});


function deltr(obj) {
   $(obj).parent().parent().remove();//移除当前行
}
function hideShowPwd(){
$('#internetpwd').hideShowPassword({
		innerToggle: true,
		touchSupport: Modernizr.touch
	});
}

$("#rescolose").click(function() {
		layer.close(index);
	})
$("#resque").click(function() {
		 $.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/set_lan_ip_and_mask",
	data: {
		ip: serverIP,
		mask:Subnet
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		 layer.close(index);
		 index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '262px'],
			shadeClose: false,
			closeBtn:0,
			content: $('#Resloading').html()
		});
		clearInterval(setinterl);
		setTimeout(function () {
		ISok(serverIP);
		},10000);
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}});
	})
 
	  var ISok = function(ip){
		var tStart = ( +new Date() ),
        host = ip || location.host,
        imgUrl = 'http://' + host + '/favicon.ico',
        time = 5000,
        timecounter = 0,
        img = null,tUse,
        wait = function(){
			tUse = Math.round( ( ( +new Date() ) - tStart ) / 1000 );
            if ( tUse > 150 ) {
				window.clearInterval( timer );
				layer.close(index);
		        layer.alert('自动连接路由器失败，请检查无线或者网线是否连接正确。');
            }else{
			layer.close(index);
		    layer.alert('重启路由器, 等待自动跳转... 用时'+tUse+'秒');	
			}
        },
        done = function(){
            window.clearInterval( timer );
			layer.alert('操作生效,重启成功！');
            window.setTimeout( 'window.top.location.href="http://'+ip+'";',3000 );
        },
        loadImg = function( onload, onerror ){
            img = new Image();
            img.onload = onload;
            img.onerror = onerror;
            img.src = imgUrl+'?' + (+new Date());
        },
        timer = window.setInterval(function() {
            if ( 'onLine' in navigator ) {
                if ( navigator.onLine ) {
                    loadImg(
                        function(){
                            done();
                        }, function(){
                            wait();
                        }
                    );
                } else {
                    wait();
                }
            }else{
                loadImg(function(){
                        done();
                    }, function(){
                        wait();
                });
            }
        }, time );
};

 function Defriendclick(ip,mac,name){
	var json="[{'ip':'"+ip+"','mac':'"+mac+"','name':'"+name+"'}]";
	index = layer.load(0, {shade: [0.5,'#252525']});
	$.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/mac_bind",
	data: {
		data:json
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		dhcpList(false);
		layer.close(index);
		layer.alert('绑定成功!');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}
});
	}
	
	function jiechuclick(mac){
	index = layer.load(0, {shade: [0.5,'#252525']});
	$.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/mac_unbind",
	data: {
		mac:mac
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		dhcpList(false);
		layer.close(index);
		layer.alert('解除绑定成功!');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}
});
	}
	
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg);  //匹配目标参数
            if (r != null) return unescape(r[2]); return null; //返回参数值
        }
</script>
