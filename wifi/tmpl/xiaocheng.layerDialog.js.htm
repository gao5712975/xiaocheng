<script src="../js/jquery.tmpl.min.js" type="text/javascript">
</script>
<script type="text/x-jquery-tmpl" id="vpn">
	<div class="VPNDialogTable">
	<form id="VpnForm" method="post" action="">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="20%" valign="top">
				<span>
					名称:
				</span>
			</td>
			<td width="80%">
				<input id="vpnName" name="vpnName" class="{required:true,messages:{required:'请输入名称'},maxlength:127} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<span>
					协议:
				</span>
			</td>
			<td>
				<select id="sel_h" name="sel_h">
				    <option value="pptp">PPTP</option>
					<option value="l2tp">L2TP</option>
				</select>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<span>
					服务器:
				</span>
			</td>
			<td>
				<input id="serverAddress" name="serverAddress" class="{required:true,messages:{required:'请输入服务器地址'},maxlength:127} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<span>
					用户名:
				</span>
			</td>
			<td>
				<input id="vpnusername" name="vpnusername" class="{required:true,messages:{required:'请输入用户名'},maxlength:127} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<span>
					密码:
				</span>
			</td>
			<td>
			    <input type="hidden" id="vpnId" />
				<input id="vpnpwd" name="vpnpwd" class="{required:true,messages:{required:'请输入密码'},maxlength:127} textinput5" type="password" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<div class="VPNDialogbut">
					<button type="submit" class="xiaobtn" id="vpnclickbtn">
						添加
						</button>
				</div>
			</td>
		</tr>
	</table>
	</form>
	</div>
</script>

<script type="text/x-jquery-tmpl" id="dns">
	<div class="VPNDialogTable">
	<form id="ddnsForm" method="post" action="">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td>
				<span>
					域名服务商:
				</span>
			</td>
			<td>
				<select id="sel_y" name="sel_y">
					<option value="1">No-ip.com</option>
					<option value="2">花生壳（oray.com）</option>
					<option value="3">公云（3322.org）</option>
					<option value="4">Dyndns.com</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>
				<span>
					用户名:
				</span>
			</td>
			<td>
				<input id="serverusername" name="serverusername" class="{required:true,messages:{required:'请输入用户名'},maxlength:127} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td>
				<span>
					密码:
				</span>
			</td>
			<td>
				<input id="serverpwd" name="serverpwd" class="{required:true,messages:{required:'请输入密码'},maxlength:127,checkChinese:true} textinput5" type="password" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td>
				<span>
					主机名称:
				</span>
			</td>
			<td>
				<input id="serverName" name="serverName" class="{required:true,messages:{required:'请输入主机名称'}} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<div class="VPNDialogbut">
					<button type="submit" class="xiaobtn">
						确定
						</button>
				</div>
			</td>
		</tr>
	</table>
	</form>
	</div>
</script>

<script type="text/x-jquery-tmpl" id="res">
  <div class="resDialog">
  <div class="reshen">
  确定要重启路由器吗？
  </div>
    <div class="reshen2">
  (该操作将暂时断开与路由器的连接)
  </div>
   <div class="reshen3 pt50">
   <div class="wifibut">
								<div class="inxiaobut left w150 ml20">
									<a class="xiaobtn" id="resque">
										确定
									</a>
								</div>
								<div class="inxiaobut left w150 ml10" id="rescolose">
									<a class="xiaobtn">
										取消
									</a>
								</div>
								<div class="clear">
								</div>
							</div>
   </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="Resloading">
  <div class="resDialog">
  <img src="../image/loading.gif" width="99" height="99" class="resloading" />
  <div class="reshen4">
  路由器正在重启，请勿断电
  </div>
    <div class="reshen2">
  需要50s
  </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="Ressuress">
  <div class="resDialog">
   <img src="../image/suerss.png" width="99" height="99" class="resloading" />
  <div class="reshen4">
  路由器重启成功！
  </div>
  </div>
</script>

<script type="text/x-jquery-tmpl" id="backup">
  <div class="resDialog">
  <img src="../image/gan.png" class="gan" />
  <div class="reshen6">
  恢复出厂设置会抹掉路由器的所有设置
  </div>
    <div class="reshen2">
  建议先备份当前设置再进行恢复
  </div>
   <div class="reshen3 pt30">
   <div class="wifibut">
								<div class="inxiaobut left w150 ml20">
									<a class="xiaobtn" id="beifen">
										备份设置
									</a>
								</div>
								<div class="inxiaobut left w150 ml10" id="quehui">
									<a class="xiaobtn">
										确定恢复
									</a>
								</div>
								<div class="clear">
								</div>
							</div>
   </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="backuploading">
  <div class="resDialog">
  <img src="../image/loading.gif" width="99" height="99" class="resloading" />
  <div class="reshen4">
  正在恢复出厂设备
  </div>
    <div class="reshen2">
  请不要关闭浏览器或断开路由器
  </div>
  </div>
</script>
<script type="text/x-jquery-tmpl" id="backupsuress">
  <div class="resDialog">
  <img src="../image/suerss.png" width="99" height="99" class="resloading" />
  <div class="reshen4">
  恢复出厂设置成功！！
  </div>
  </div>
</script>

<script type="text/x-jquery-tmpl" id="black">
	<div class="VPNDialogTable">
	<form id="blackForm" method="post" action="">
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td valign="top">
				<span>
					设备名:
				</span>
			</td>
			<td>
				<input id="facilityName" name="facilityName" class="{required:true,messages:{required:'请输入设备名'},maxlength:43,checkspecial2:true} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td valign="top">
				<span>
					MAC地址:
				</span>
			</td>
			<td>
				<input id="MACAddress" name="MACAddress" class="{required:true,messages:{required:'请输入MAC地址'},checkMac:true} textinput5" type="text" />
				<div class="Prompt3"></div>
			</td>
		</tr>
		<tr>
			<td colspan="2">
				<div class="VPNDialogbut">
					<button class="xiaobtn" type="submit">
						确定
						</button>
				</div>
			</td>
		</tr>
	</table>
	</form>
	</div>
</script>

<script type="text/x-jquery-tmpl" id="WhiteEquipmentlist">
<div class="blackbai">
			<div class="blackbaititle">
				已连接无线设备
				<font>
					（允许访问的设备）
				</font>
			</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="blacktr">
							<tr>
								<td width="25%">
									设备名
								</td>
								<td width="25%">
									IP地址
								</td>
								<td width="25%">
									MAC地址
								</td>
								<td width="25%">
									操作
								</td>
							</tr>
						</table>
						<td>
				</tr>
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="baixian">
							{{each(i,device) devicelist}}
							{{if device.type=='wifi'}}
							<tr>
								<td width="25%">
									${device.name}
								</td>
								<td width="25%">
									${device.ip}
								</td>
								<td width="25%">
									${device.mac}
								</td>
								<td width="25%">
									<a class="xbtn" onclick="Defriendclick('${device.mac}')" href="javascript:;">
										拉黑
									</a>
								</td>
							</tr>
							{{/if}}	
							{{/each}}
						</table>
					</td>
				</tr>
			</table>
		</div>
</script>     
<script type="text/x-jquery-tmpl" id="BlackEquipmentlist">
		<div class="blackbai">
			<div class="blackbaititle">
				黑名单列表
				<font>
					（不允许访问的设备）
				</font>
			</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="blacktr">
							<tr>
								<td width="34%">
									设备名
								</td>
								<td width="33%">
									MAC地址
								</td>
								<td width="33%">
									操作
								</td>
							</tr>
						</table>
						<td>
				</tr>
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="baixian">
						{{each(i,device2) macfilter}}
							<tr>
								<td width="34%">
									${device2.name}
								</td>
								<td width="33%">
									${device2.mac}
								</td>
								<td width="33%">
									<a class="xbtn" onclick="yunxuclick('${device2.mac}')" href="javascript:;">
										允许
									</a>
								</td>
							</tr>
				         {{/each}}
						</table>
					</td>
				</tr>
			</table>
		</div>
</script>
<script type="text/x-jquery-tmpl" id="Vpnlist">
<div class="vpnblackbai">
                        <div class="blackbaititle">
			VPN服务列表
			</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="blacktr">
							<tr>
								<td width="16%">
									名称
								</td>
								<td width="16%">
									协议
								</td>
								<td width="20%">
									服务器地址
								</td>
								<td width="16%">
									用户名
								</td>
                                <td width="16%">
									状态
								</td>
                                <td width="16%">
									操作
								</td>
							</tr>
						</table>
						<td>
				</tr>
				<tr>
					<td>
					{{each(i,vpn) list}}
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="baixian">
                                <tr>
								<td width="16%">
									${vpn.oname}
								</td>
								<td width="16%">
									${vpn.proto.toUpperCase()}
								</td>
								<td width="20%">
									${vpn.server}
								</td>
								<td width="16%">
									${vpn.username}
								</td>
                                <td width="16%">
								<div id="vpn${vpn.id}">
								 断开 | <a onclick="GetswitchVpn(1,'${vpn.id}')" href="javascript:;" class="ddnsfont">连接</a>
								</div>
								</td>
                                <td width="16%">
									<a class="ddnsfont editVpn" data-id="${vpn.id}" href="javascript:;">编辑</a> | <a onclick="delVpn('${vpn.id}')" class="ddnsfont" href="javascript:;">删除</a>
								</td>
							</tr>
						</table>
					{{/each}}
					</td>
				</tr>
               
			</table>
		</div>
</script>
<script type="text/x-jquery-tmpl" id="Upnplist">
<div class="upnpblackbai">
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="blacktr">
							<tr>
								<td width="20%">
									应用名称
								</td>
								<td width="20%">
									协议
								</td>
								<td width="20%">
									IP客户端
								</td>
								<td width="20%">
									内部端口
								</td>
                                <td width="20%">
									外部端口
								</td>
							</tr>
						</table>
						<td>
				</tr>
				<tr>
					<td>
					{{each(i,upnp) list}}
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="baixian">
							<tr>
								<td width="20%">
									${upnp.name}
								</td>
                                <td width="20%">
									${upnp.protocol}
								</td>
                                <td width="20%">
									 ${upnp.ip}
								</td>
                                <td width="20%">
									${upnp.cport}
								</td>
                                <td width="20%">
									${upnp.rport}
								</td>
							</tr>
						</table>
						{{/each}}
					</td>
				</tr>
			</table>
		</div>
</script>
<script type="text/x-jquery-tmpl" id="ddnslist">
<div class="ddnsblackbai">
                        <div class="blackbaititle">
			DDNS服务列表
			</div>
			<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="blacktr">
							<tr>
								<td width="25%">
									服务商
								</td>
								<td width="25%">
									主机名称
								</td>
								<td width="25%">
									连接状态
								</td>
								<td width="25%">
									操作
								</td>
							</tr>
						</table>
						<td>
				</tr>
				<tr>
					<td>
					{{each(i,ddns) list}}
						<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0"
						class="baixian">
							<tr>
								<td width="25%">
									${ddns.servicename}
								</td>
                                <td width="25%">
									${ddns.domain}
								</td>
                                <td width="25%">
								
								{{if ddns.enabled==1}}
									已启用 | <a class="ddnsfont" onclick="setserverswitch('${ddns.id}',0)" href="javascript:;">暂停</a>
									{{else}}
						            未启用 | <a class="ddnsfont" onclick="setserverswitch('${ddns.id}',1)" href="javascript:;">开启</a>
						            {{/if}}	
								
									 
								</td>
                                <td width="25%">
									<a class="ddnsfont" id="editDdns" onclick="setddnsClick('${ddns.id}')" href="javascript:;">编辑</a> | <a onclick="delddns('${ddns.id}')" class="ddnsfont" href="javascript:;">删除</a>
								</td>
							</tr>
						</table>
						{{/each}}
					</td>
				</tr>
                <tr>
									<td>
											<div class="ddnsbut">
												<a class="xiaobtn" id="ddnsbtn" href="javascript:;">
													添加服务
												</a>
											</div>
									</td>
								</tr>
			</table>
		</div>
</script>
<script src="../js/jquery.selectlist.js">
</script>
<script type="text/javascript">
    var index,ddnsstate,url,enabled,index2,restartcount=1,backupcount=1,ipaddress;
    $('#vpndialogtable').html($("#vpn").html());
	$('#ddnsdialogtable').html($("#dns").html());
	$('#Resdialogtable').html($("#res").html());
	$('#Backupdialogtable').html($("#backup").html());
	$('#blackdialogtable').html($("#black").html());
	$("#vpnbtn").click(function() {
		index=layer.open({
			type: 1,
			title: '添加VPN服务',
			area: ['500px', 'auto'],
			shadeClose: false,
			content: $('#vpndialogtable'),
			cancel: function(index){ window.location.reload(); }
		});
	})
	
	function setserverswitch(id,on)
		{
		index = layer.load(0, {shade: [0.5,'#252525']});
			$.ajax({
			type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/server_switch",
	data: {
		id:id,
		on:on
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
			Getddnslist();
		layer.close(index);
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.msg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}});
		}
	
	function setddnsClick(id){
		
		$.getJSON("http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/get_server",{id:id},function(result)
	        {
			if(result.code=='0'){
				
				index=layer.open({
			type: 1,
			title: '编辑DDNS服务',
			area: ['500px', 'auto'],
			shadeClose: false,
			content: $('#ddnsdialogtable'),
			cancel: function(index){ window.location.reload(); }
		    });
			
		   ddnsstate=1;
           $('#serverusername').val(result.username),
		   $('#serverpwd').val(result.password),
	       $('#serverName').val(result.domain)
           $("#sel_y").find("option[value='"+id+"']").attr("selected",true);
		   enabled=result.enabled;
		   drpsel_ye();
			//$("#sel_y").find("[data-value='"+id+"']").click();
			}else{layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);}
			});
	}
	
	function setVpnClick(){
	$(".editVpn").click(function() {
		  var that = this,proto,
              $this = $(that),
              id = $this.attr('data-id');
		$.getJSON("http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/vpn",function(result)
	        {
			if(result.code=='0'){
				
				var list = result.list;
                    if ( list.length > 0 ) {
                        for (var i = 0; i < list.length; i++) {
                             if ( list[i].id == id) {
                                $('#vpnName').val(list[i].oname);
								proto=list[i].proto,
                                $('#serverAddress').val(list[i].server),
		                        $('#vpnusername').val(list[i].username),
	                        	$('#vpnpwd').val(list[i].password),
								$('#vpnId').val(list[i].id),
								$('#vpnclickbtn').html('保存')
                            }
                        }
                    }
				index=layer.open({
			type: 1,
			title: '编辑VPN服务',
			area: ['500px', 'auto'],
			shadeClose: false,
			content: $('#vpndialogtable'),
			cancel: function(index){ window.location.reload(); }
		    });
			$("#sel_h").find("[data-value='"+proto+"']").click();
			}else{layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);}
			});
	})}
	
	$("#blackbtn").click(function() {
		index=layer.open({
			type: 1,
			title: '添加黑名单设备',
			area: ['500px', 'auto'],
			shadeClose: false,
			content: $('#blackdialogtable')
		});
	})
	
	$("#rescolose").click(function() {
		layer.close(index);
	})
	
	function ddnsbtn(){
	$("#ddnsbtn").click(function() {
		 index=layer.open({
			type: 1,
			title: 'DDNS服务',
			area: ['500px', 'auto'],
			shadeClose: false,
			content: $('#ddnsdialogtable'),
			cancel: function(index){ window.location.reload(); }
		});
		drpsel_y();
	})}
	
	$("#resbtn").click(function() {
		index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '262px'],
			shadeClose: false,
			content: $('#Resdialogtable')
		});
	})
	
	$("#backupbtn").click(function() {
		index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '350px'],
			shadeClose: false,
			content: $('#Backupdialogtable')
		});
	})
	
	$("#resque").click(function() {
		layer.close(index);
      index2 = layer.load(0, {shade: [0.5,'#252525']});
         	 $.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/reboot",
	data: {},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		layer.close(index2);
		index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '262px'],
			shadeClose: false,
			closeBtn:0,
			content: $('#Resloading').html()
		});
		setTimeout(function () {setinterl=setInterval(function(){        
		
		if(restartcount<=4){restartcount=restartcount+1;ISok();}
									  else{clearInterval(setinterl);layer.close(index);
           layer.alert('无法自动连接路由器！请检查无线或者网线是否连接正确，尝试关闭路由器电源再重新通电启动，等待70秒重启完毕后，再重新打开浏览器访问管理页面。');}
		}, 5000);},50000);
		//setTimeout(function () {ISok();},10000);
		}else
		{
		layer.close(index2);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index2);
		layer.alert("错误信息："+errmsg);
	}});
	})
	
	
	
	
	$("#quehui").click(function() {
		layer.close(index);
	$.getJSON("http://192.168.1.3/cgi-bin/luci/cheng/systeminfo/get_default_ip",function(result)
	{
	  if(result.code=='0') 
	  {
		  ipaddress=result.ipaddr;
		 //恢复出厂设置
		 $.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/reset_default",
	data: {},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
	     index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '262px'],
			shadeClose: false,
			closeBtn:0,
			content: $('#backuploading').html()
		});
	   setTimeout(function () {setinterl=setInterval(function(){
		   
		   if(backupcount<=4){backupcount=backupcount+1;ISok2();}
									  else{clearInterval(setinterl);layer.close(index);
           layer.alert('无法自动连接路由器！请检查无线或者网线是否连接正确，尝试关闭路由器电源再重新通电启动，等待70秒重启完毕后，再重新打开浏览器访问管理页面。');}
		   }, 5000);},100000);
		//setTimeout(function () {ISok2();},10000);
		}else
		{
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.alert("错误信息："+errmsg);
	}
});
	  }
	});
	})
	
	
	
	function ISok2()
   {
	$.ajax({
	type: "get",
	timeout: 120000,
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/is_reboot_ok",
	dataType: "json",             
	success: function(result) {
	   if(result.code=='0') 
	   {
		layer.close(index);
		clearInterval(setinterl);
			index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['499px', '232px'],
			shadeClose: false,
			closeBtn:0,
			content: $('#backupsuress').html()
		});  
		setTimeout(function () {layer.close(index);
		location.href = 'http://'+ipaddress;
		},5000) 
	   }
	   else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	 },
	 error: function(jqXHR, textStatus, errorThrown) {
		/*if(textStatus=="timeout"){ 
		   layer.close(index); 
           layer.alert('恢复出厂设备超时提示：恢复出厂设备异常！请尝试关闭路由器电源再重新通电启动，等待70秒重启完毕后，重新打开浏览器访问管理页面。');
        }else{
          layer.close(index);
		 layer.alert("错误信息："+textStatus);
		}*/
		}
	  });
 }

function drpsel_y(){
	$('#sel_y').selectlist({
		zIndex: 10,
		width: 259,
		height: 39,
		borderRadius: 5
	});}

function drpsel_ye(){
	$('#sel_y').selectlist({
		zIndex: 10,
		width: 259,
		height: 39,
		borderRadius: 5,
		enable:false
	});}
	
	$('#sel_h').selectlist({
		zIndex: 10,
		width: 259,
		height: 39,
		borderRadius: 5
	});
	
	function Defriendclick(mac){
	index = layer.load(0, {shade: [0.5,'#252525']});
	$.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/modify_mac_filter",
	data: {
		option: '0',
		mode: '0',
		mac:mac
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		GetWhiteEquipmentlist();
		GetBlackEquipmentlist();
		layer.close(index);
		layer.alert('操作成功!');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}
});
	}
	
	function yunxuclick(mac)
	{
		index = layer.load(0, {shade: [0.5,'#252525']});
	$.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/modify_mac_filter",
	data: {
		option: '1',
		mode: '0',
		mac:mac
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
		GetWhiteEquipmentlist();
		GetBlackEquipmentlist();
		layer.close(index);
		layer.alert('操作成功!');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}
});
	}
	

function GetVpnList()
	{
		$.getJSON("http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/vpn",function(result)
	        {
			if(result.code=='0'){
				currentId=result.current.id;
				$('#VpnlistDiv').empty();
				$('#Vpnlist').tmpl(result).appendTo('#VpnlistDiv');
				setVpnClick();
			}else{layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);}
			});
	}
	
	function delVpn(id)
	{
		index = layer.load(0, {shade: [0.5,'#252525']});
		  $.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/del_vpn",
	data: {
		id:id
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
			GetVpnList();
			layer.close(index);
			layer.alert('删除成功');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}});
	}
	
	
	function delddns(id)
	{
		index = layer.load(0, {shade: [0.5,'#252525']});
		  $.ajax({
	type: "post",
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/del_server",
	data: {
		id:id
	},
	dataType: "json",             
	success: function(result) {
		if(result.code=='0'){
			Getddnslist();
			layer.close(index);
			layer.alert('删除成功');
		}else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	},
	error: function(errmsg) {
		layer.close(index);
		layer.alert("错误信息："+errmsg);
	}});
	}
	
	function vpnStatus(){
        $.getJSON('http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/vpn_status',function(rsp){
            if (rsp.code == 0) {
                var status = rsp.status;
                switch(status){
                    case 0:
                        statusText = "连接 | <a onclick=\"GetswitchVpn(0,'"+currentId+"')\" href='javascript:;' class='ddnsfont'>断开</a>";
                        break;
                    case 1:
                        statusText = "正在拨号";
                        break;
                    case 2:
                        statusText = "连接失败 | <a onclick=\"GetswitchVpn(1,'"+currentId+"')\" href='javascript:;' class='ddnsfont'>重新连接</a>";
						break;
                    case 3:
                        statusText = "断开 | <a onclick=\"GetswitchVpn(1,'"+currentId+"')\" href='javascript:;' class='ddnsfont'>连接</a>";
                        break;
                    case 4:
                        statusText = "未启用 | <a onclick=\"GetswitchVpn(1,'"+currentId+"')\" href='javascript:;' class='ddnsfont'>连接</a>";
                        break;
                    default:
                        statusText = "连接异常 | <a onclick=\"GetswitchVpn(1,'"+currentId+"')\" href='javascript:;' class='ddnsfont'>重新连接</a>";
                        break;
                }
				if(currentId!=''){
                $('#vpn'+currentId).html(statusText);}
            }else
		        {
		           layer.close(index);
		            layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		        }
        });
    }
	
	
	function GetswitchVpn(conn,id)
	{
		index = layer.load(0, {shade: [0.5,'#252525']});
		$.getJSON("http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/vpn_switch",{conn:conn,id:id},function(result)
	        {
			
			if(result.code=='0'){
				layer.close(index);
				GetVpnList();
				vpnStatus();
				//window.location.reload();
			}else{layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);}
			});
	}
	
	$("#archive").change(function(){
	 ajaxFileUpload();
	});
	
	function ajaxFileUpload() {
			$.ajaxFileUpload
            (
                {
                    url: 'http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/config_restore', //用于文件上传的服务器端请求地址
                    secureuri: false, //是否需要安全协议，一般设置为false
                    fileElementId: 'archive', //文件上传域的ID
                    dataType: 'json', //返回值类型 一般设置为json
					type:'post',
                    success: function (data, status)  //服务器成功响应处理函数
                    {
                         if(data.code=='0'){
						    index=layer.open({
		                         type: 1,
		                         title: '操作提示',
			                     area: ['460px', '262px'],
			                     shadeClose: false,
			                     content: $('#Resloading').html()
		                      });
							  setTimeout(function () {
		                       setinterl=setInterval(function(){ISok();}, 5000);
		                      },50000);
						   }
                    },
                    error: function (data, status, e)//服务器响应失败处理函数
                    {
                        layer.alert('错误码:'+data.code+"/错误信息："+data.msg);
                    }
                }
            )
            return false;
        }
	 
   function ISok()
   {
	$.ajax({
	type: "get",
	timeout: 70000,
	url: "http://192.168.1.3/cgi-bin/luci/cheng/networkmanager/is_reboot_ok",
	dataType: "json",             
	success: function(result) {
	   if(result.code=='0') 
	   {
		layer.close(index);
		clearInterval(setinterl);
			index=layer.open({
			type: 1,
			title: '操作提示',
			area: ['460px', '262px'],
			shadeClose: false,
			closeBtn:0,
			content: $('#Ressuress').html()
		});  
		setTimeout(function () {layer.close(index);
		location.href = "../login.htm";
		},5000) 
	   }
	   else
		{
		layer.close(index);
		layer.alert('错误码:'+result.code+"/错误信息："+result.errmsg);
		}
	 },
	 error: function(jqXHR, textStatus, errorThrown) {
		/*if(textStatus=="timeout"){ 
		   layer.close(index); 
           layer.alert('重启超时提示：重启异常！请尝试关闭路由器电源再重新通电启动，等待70秒重启完毕后，重新打开浏览器访问管理页面。');
        }else{
           layer.close(index);
		   layer.alert("错误信息："+textStatus);
		}*/
		}
	  });
 }
</script>